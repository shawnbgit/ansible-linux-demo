---
- name: update and install tc3 runtime
  hosts: controllers
  become: yes
  gather_facts: no

  vars:
    apt_lock_timeout: 300

  tasks:
    - name: update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
        force_apt_get: yes
        lock_timeout: "{{ apt_lock_timeout }}"
      register: apt_update

    - name: show apt update output
      debug:
        var: apt_update.stdout_lines
      when: apt_update.stdout_lines is defined

    - name: install or upgrade tc3 runtime
      apt:
        name: tc31-xar-um
        state: latest
        force_apt_get: yes
        lock_timeout: "{{ apt_lock_timeout }}"
      register: tc_install

    - name: install summary
      debug:
        msg:
          - "changed={{ tc_install.changed }}"
          - "stdout:"
          - "{{ (tc_install.stdout | default('')).splitlines() }}"
          - "stderr:"
          - "{{ (tc_install.stderr | default('')).splitlines() }}"
          -
    - name: stop nftables firewall
      ansible.builtin.systemd:
        name: nftables
        state: stopped

    - name: disable nftables at boot
      ansible.builtin.systemd:
        name: nftables
        enabled: no

    - name: write static network config for end0
      ansible.builtin.copy:
        dest: /etc/systemd/network/10-end0-static.network
        owner: root
        group: root
        mode: "0644"
        content: |
          [Match]
          Name=end0

          [Network]
          Address=192.168.2.101/24
          Gateway=192.168.2.1
          DNS=192.168.2.1 8.8.8.8

    - name: reboot fire & forget, godspeed ðŸ«¡
      ansible.builtin.shell: |
        nohup sh -c 'sleep 2 && systemctl reboot' >/dev/null 2>&1 &
      async: 1
      poll: 0
      ignore_errors: true

    - name: stop running tasks on this host
      meta: end_host
